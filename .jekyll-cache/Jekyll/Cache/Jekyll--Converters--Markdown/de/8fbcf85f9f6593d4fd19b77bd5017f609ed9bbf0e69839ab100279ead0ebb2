I"ó'<p class="lead"><strong><em>‚ÄúTechnology is just a tool. In terms of getting the kids working together and motivating them, the teacher is the most important.‚Äù</em></strong>   - Bill Gates</p>
<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/poster.jpeg" alt="" /></p>

<ul class="large-only" id="markdown-toc">
  <li><a href="#machine-matrix" id="markdown-toc-machine-matrix">Machine Matrix</a></li>
  <li><a href="#machine-summary" id="markdown-toc-machine-summary">Machine Summary</a></li>
  <li><a href="#nmap-scan" id="markdown-toc-nmap-scan">Nmap Scan</a></li>
  <li><a href="#enumeration-on-port-80" id="markdown-toc-enumeration-on-port-80">Enumeration on port 80</a></li>
  <li><a href="#enumerating-with-usernames" id="markdown-toc-enumerating-with-usernames">Enumerating with usernames</a></li>
  <li><a href="#kerberos-pre-authentication" id="markdown-toc-kerberos-pre-authentication">Kerberos Pre-Authentication</a></li>
  <li><a href="#acquring-user-shell" id="markdown-toc-acquring-user-shell">Acquring User Shell</a></li>
  <li><a href="#privilege-escalation" id="markdown-toc-privilege-escalation">Privilege Escalation</a></li>
</ul>

<h2 id="machine-matrix">Machine Matrix</h2>
<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/machinematrix.png" alt="" /></p>

<h2 id="machine-summary">Machine Summary</h2>
<p>Box has an webapplication running, from which we enumerated the usernames. We made certain modifications on the usernames and ran GetNPUsers.py from impacket library inorder to check whether any user has kerberos pre-authentication disabled. As expected one (fsmith) user as kerberos pre-authentication disabled and using winrm we get the user shell. Now for privilege escalation, we find that there is a default crendentials stored for a user (svs_loanmgr) but that that is not the administrator. We use secretsdump.py again from impacket library to dump the crendentials of all the user including the administrator.</p>

<h2 id="nmap-scan">Nmap Scan</h2>
<p>I started the enumeration with nmap scan</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> 10.10.10.10.175
</code></pre></div></div>
<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/1.png" alt="" /></p>

<p>The Box had 12 ports open</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Port</th>
      <th style="text-align: left">Service</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">53</td>
      <td style="text-align: left">domain</td>
    </tr>
    <tr>
      <td style="text-align: left">80</td>
      <td style="text-align: left">http IIS Server</td>
    </tr>
    <tr>
      <td style="text-align: left">88</td>
      <td style="text-align: left">kerberos-sec</td>
    </tr>
    <tr>
      <td style="text-align: left">135</td>
      <td style="text-align: left">msrpc</td>
    </tr>
    <tr>
      <td style="text-align: left">139</td>
      <td style="text-align: left">netbios-ssn</td>
    </tr>
    <tr>
      <td style="text-align: left">389</td>
      <td style="text-align: left">ldap</td>
    </tr>
    <tr>
      <td style="text-align: left">445</td>
      <td style="text-align: left">microsoft-ds</td>
    </tr>
    <tr>
      <td style="text-align: left">464</td>
      <td style="text-align: left">kpasswd5</td>
    </tr>
    <tr>
      <td style="text-align: left">593</td>
      <td style="text-align: left">ncacan_http</td>
    </tr>
    <tr>
      <td style="text-align: left">636</td>
      <td style="text-align: left">tcpwrapped</td>
    </tr>
    <tr>
      <td style="text-align: left">3268</td>
      <td style="text-align: left">ldap</td>
    </tr>
    <tr>
      <td style="text-align: left">3269</td>
      <td style="text-align: left">tcpwrapped</td>
    </tr>
  </tbody>
</table>

<h2 id="enumeration-on-port-80">Enumeration on port 80</h2>
<p>I enumerated on the webapplication to check if there is any misconfigurations that could lead us to initial foothold but that didnt end well. We have potential names of the employees and check with any of the user have kerberos pre-authentication disabled.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fergus smith
shaun coins
sophie driver
bowie taylor
hugo bear
steven kerb
</code></pre></div></div>

<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/2.png" alt="" /></p>

<h2 id="enumerating-with-usernames">Enumerating with usernames</h2>

<p>I formed a list of usernames of the  Active Directory, i formed the list using certain naming conventions such as username for John Melon can be</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>j.melon 
jmelon
johnm
john.melon
john.m
</code></pre></div></div>
<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/3.png" alt="" /></p>

<h2 id="kerberos-pre-authentication">Kerberos Pre-Authentication</h2>
<p>The Key Distribution Center (KDC) is available as part of the domain controller and performs two key functions which are: Authentication Service (AS) and Ticket-Granting Service (TGS)</p>

<p>By default the KDC requires all accounts to use pre-authentication. This is a security feature which offers protection against password-guessing attacks. The AS request identifies the client to the KDC in plain text. If pre-authentication is enabled, a time stamp will be encrypted using the user‚Äôs password hash as an encryption key. If the KDC reads a valid time when using the user‚Äôs password hash, which is available in the Active Directory, to decrypt the time stamp, the KDC knows that request isn‚Äôt a replay of a previous request.</p>

<p>When you do not enforce pre-authentication, a malicious attacker can directly send a dummy request for authentication. The KDC will return an encrypted TGT and the attacker can brute force it offline.</p>

<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/kerberos_preauthentication.png" alt="" /></p>

<h2 id="acquring-user-shell">Acquring User Shell</h2>
<p>Some time kerberos pre-authentication is disabled for the domain users. As mentioned earlier we can get the encrypted TGT with a dumy query using GetNPUsers.py from impacket library with the username list that i have formed.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GetNPUsers.py EGOTISTICAL-BANK.LOCAL/ <span class="nt">-usersfile</span> usernames.txt <span class="nt">-no-pass</span> <span class="nt">-format</span> john <span class="nt">-outputfile</span> hash.txt
</code></pre></div></div>
<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/4.png" alt="" /></p>

<p>I was able to retrive the kerberos hash for the username fsmith</p>

<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/5.png" alt="" /></p>

<p>I cracked the obtained hash of fsmith using john, the password for fsmith was <strong><em>Thestrokes23</em></strong></p>

<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/6.png" alt="" /></p>

<p>Now i used evil-winrm tool with the username as <em>fsmith</em> and password as <em>Thestrokes23</em> to get the shell.</p>

<h2 id="privilege-escalation">Privilege Escalation</h2>
<p>As usual i ran winpeas for enumerating on the privilege escalation, found there was an autologon credentials for the user svc_loanmanager</p>

<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/7.png" alt="" /></p>

<p>we can also manually verify it using the command:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WinLogon"</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="nx">DefaultPassword</span><span class="w">
</span></code></pre></div></div>
<p>or</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">REG</span><span class="w"> </span><span class="nx">QUERY</span><span class="w"> </span><span class="s2">"HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WinLogon"</span><span class="w"> </span><span class="nx">/v</span><span class="w"> </span><span class="nx">DefaultPassword</span><span class="w"> </span><span class="nx">/reg:64</span><span class="w">
</span></code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Auto Logon Credentials
username: svc_loanmanager
password: Moneymakestheworldgoround!
</code></pre></div></div>
<p>Getting the administrator access won‚Äôt be this simple, i was not able to get the shell for  the user svc_loanmanager. The user‚Äôs folder had only fmsith, svc_loanmgr, administrator (enumerated using the fsmith access).
Now i tried with the username svc_loanmgr, got the shell
I manually enumerated it and found that it is a part of domain controlle</p>

<p>So i ran secretsdump.py to dump the credentials of all the users.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>secretsdump.py EGOTISTICAL-BANK.local/svc_loanmgr@EGOTISTICAL-BANK.local
</code></pre></div></div>
<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/8.png" alt="" /></p>

<p>Now i used the NTLM hash of the administrator directly in evil-winrm to get the shell</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>evil-winrm <span class="nt">-i</span> 10.10.10.175 <span class="nt">-u</span> administrator <span class="nt">-H</span> <span class="o">{</span>HASH<span class="o">}</span>
</code></pre></div></div>
<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/9.png" alt="" /></p>

<p><img src="http://localhost:4000//assets/img/blog/HTB/sauna/sauna.png" alt="" /></p>

<p>Happy Hacking!</p>
:ET